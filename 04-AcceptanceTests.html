
<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Codeception.docs.ja : Codeception docs japanese translation">

    <link rel="stylesheet" type="text/css" media="screen" href="//piccagliani.github.io/Codeception.docs.ja_JP/stylesheets/stylesheet.css">

    <title>Codeception.docs.ja</title>
</head>

<body>

<!-- HEADER -->
<div id="header_wrap" class="outer">
    <header class="inner">
        <a id="forkme_banner" href="https://github.com/piccagliani/Codeception.docs.ja_JP">View on GitHub</a>

        <h1 id="project_title">Codeception.docs.ja</h1>
        <h2 id="project_tagline">Codeception docs japanese translation</h2>

        <section id="downloads">
            <a class="zip_download_link" href="https://github.com/piccagliani/Codeception.docs.ja_JP/zipball/master">Download this project as a .zip file</a>
            <a class="tar_download_link" href="https://github.com/piccagliani/Codeception.docs.ja_JP/tarball/master">Download this project as a tar.gz file</a>
        </section>
    </header>
</div>

<!-- MAIN CONTENT -->
<div id="main_content_wrap" class="outer">
    <section id="main_content" class="inner">
        <h1>受け入れテスト</h1>

<p>受け入れテストは、技術者ではない人でも実行することが出来ます。技術者ではないテスターやマネージャー、あるいはクライアントでも実行出来ます。
あなたがウェブアプリケーションを開発している場合、（おそらくあなた自身である）テスターは、あなたのサイトが正しく動いているかをチェックするのにウェブブラウザ以外に必要なものはありません。
シナリオでAcceptanceTesterクラスの行動を再現することによって、サイトを変更する毎にそれらを自動的に実行することができます。
AcceptanceTesterの言葉から記録されたかのようCodeceptionは、テストを簡潔に保ってくれます。</p>

<p>CMSやフレームワークをアプリケーションに取り入れていても違いはありません。Java、.NETなど異なるプラットフォームでさえ同じようにテスト出来ます。
どんな時でも、あなたのウェブサイトにテストを加えるということは良い考えだと言えるでしょう。
少なくとも、最後の変更からアプリケーションがしっかりと機能していることに確信が持てるでしょう。</p>

<h2>シナリオサンプル</h2>

<p>おそらく、最初に実行したいテストはサインインする機能でしょう。そのようなテストを書くためには、基本的なPHPとHTMLの知識が必要です。</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$I</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AcceptanceTester</span><span class="p">(</span><span class="nv">$scenario</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">wantTo</span><span class="p">(</span><span class="s1">&#39;sign in&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">amOnPage</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">fillField</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;davert&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">fillField</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;qwerty&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">click</span><span class="p">(</span><span class="s1">&#39;LOGIN&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">see</span><span class="p">(</span><span class="s1">&#39;Welcome, Davert!&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>このシナリオは、おそらく非技術者の人でも読めます。Codeceptionはシナリオを平易な英語に変換し、&#39;自然言語化&#39;することさえ出来ます:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">I WANT TO SIGN IN
I am on page <span class="s1">&#39;/login&#39;</span>
I fill field <span class="s1">&#39;username&#39;</span>, <span class="s1">&#39;davert&#39;</span>
I fill field <span class="s1">&#39;password&#39;</span>, <span class="s1">&#39;qwerty&#39;</span>
I click <span class="s1">&#39;LOGIN&#39;</span>
I see <span class="s1">&#39;Welcome, Davert!&#39;</span>
</code></pre></div>
<p>そのような自然言語への翻訳は、コマンドによって行われます:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>php codecept.phar generate:scenarios
</code></pre></div>
<p>作成されたシナリオは <strong>tests/_data</strong>ディレクトリにテキストファイルとして格納されます。</p>

<p><strong>このシナリオテストはシンプルなPHP BrowserでもSelenium WebDriverを使ったブラウザでも実行することが出来ます。</strong>まずはPHP Browserで受け入れテストを書いて行きましょう。</p>

<h2>PHP Browser</h2>

<p>実際に動くブラウザが必要となるまでは、これはもっとも速く受け入れテストを実行する方法です。
リクエストを送り、それからレスポンスを受け取って解析する、というようなブラウザのような動きをするPHP web scraperを使用しています。
Codeceptionは<a href="http://guzzlephp.org">Guzzle</a>とSymfony BrowserKitをHTMLページを操作するのに使用しています。
HTMLのある要素の実際の可視性や、javascriptの動作をテストできないことに注意してください。
PHP Browserの利点は、PHPとcURLだけでどんな環境でも実行できることです。</p>

<p>一般的なPHP Browserの欠点：</p>

<ul>
<li>有効なURLのリンクとフォームの送信ボタンしかクリックできないこと</li>
<li>フォームの中にないフィールドには書き込めないこと</li>
<li>JavaScriptによる動作は機能しないこと：モーダルを表示させたり、datepickersの使用など</li>
</ul>

<p>テストを書き始める前に、アプリケーションが動作しているホストをローカルコピーしてください。
受け入れテストスイートの設定ファイル (tests/acceptance.suite.yml) に、<code>url</code>パラメータを指定する必要があるからです。</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">class_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">AcceptanceTester</span>
<span class="l-Scalar-Plain">modules</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">enabled</span><span class="p-Indicator">:</span>
        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">PhpBrowser</span>
        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">AcceptanceHelper</span>
        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Db</span>
    <span class="l-Scalar-Plain">config</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">PhpBrowser</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">your site&#39;s url</span><span class="p-Indicator">]</span>
</code></pre></div>
<p>それでは、<strong>tests/acceptance</strong>ディレクトリに&#39;Cept&#39;ファイルを作成してください。ファイル名は <strong>SigninCept.php</strong>とします。
最初の行に以下のように書きます。</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$I</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AcceptanceTester</span><span class="p">(</span><span class="nv">$scenario</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">wantTo</span><span class="p">(</span><span class="s1">&#39;sign in with valid account&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p><code>wantTo</code>という部分はシナリオを簡潔に説明しています。
他にもBDDのようなCodeceptionのシナリオを書くための有用なコメント追加メソッドがあります。GherkinでBDDのシナリオを書いたことがある人なら、以下のようにフィーチャーを書くことができます。</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">As an Account Holder
I want to withdraw cash from an ATM
So that I can get money when the bank is closed
</code></pre></div>
<p>Codeceptionでは以下のように書きます:</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$I</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AcceptanceTester</span><span class="p">(</span><span class="nv">$scenario</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">am</span><span class="p">(</span><span class="s1">&#39;Account Holder&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">wantTo</span><span class="p">(</span><span class="s1">&#39;withdraw cash from an ATM&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">lookForwardTo</span><span class="p">(</span><span class="s1">&#39;get money when the bank is closed&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>ストーリーの前提を説明した上で、シナリオを書き始めましょう。</p>

<p>この <code>$I</code>オブジェクトは、すべての動作を記述するために使われます。<code>$I</code>オブジェクトのメソッドは<code>PhpBrowser</code>モジュールや<code>Db</code>モジュールから取得されています。
簡単にそれを説明します：</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">amOnPage</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>常に<code>am</code>は、最初の状態を記述するように想定しています。<code>amOnPage</code>メソッドは<strong>/login</strong>ページが最初の状態だと設定しています。</p>

<p><code>PhpBrowser</code>では、リンクのクリックとフォームを埋めることが出来ます。これらは、おそらくもっとも多い動作だと思います。</p>

<h4>クリック</h4>

<p>有効なリンクのクリックをエミュレートします。
&quot;href&quot;属性の値のページが開きます。リンク名やCSSセレクター、XPathでクリックするリンクを指定できます。</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">click</span><span class="p">(</span><span class="s1">&#39;Log in&#39;</span><span class="p">);</span>
<span class="c1">// CSSセレクターを使用する場合</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">click</span><span class="p">(</span><span class="s1">&#39;#login a&#39;</span><span class="p">);</span>
<span class="c1">// XPathを使用する場合</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">click</span><span class="p">(</span><span class="s1">&#39;//a[@id=login]&#39;</span><span class="p">);</span>
<span class="c1">// 第二引数としてコンテキストを使用する場合</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">click</span><span class="p">(</span><span class="s1">&#39;Login&#39;</span><span class="p">,</span> <span class="s1">&#39;.nav&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>Codeceptionは、テキストやname属性、CSSセレクタ、XPathのどれかで要素を検索しようとします。
locatorの種類を配列として渡すことで、指定することもできます。我々は <strong>strict locator</strong>呼んでいます。
利用できるstrict locatorの種類は以下です：</p>

<ul>
<li>id</li>
<li>name</li>
<li>css</li>
<li>xpath</li>
<li>link</li>
<li>class</li>
</ul>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">// locatorの種類で指定する場合</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">click</span><span class="p">([</span><span class="s1">&#39;link&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Login&#39;</span><span class="p">]);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">click</span><span class="p">([</span><span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;btn&#39;</span><span class="p">]);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>リンクをクリックする前に、本当にリンクが存在するかどうかチェックすることもできます。
その場合<code>seeLink</code>メソッドを使用します。</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">// 実際にリンクが存在するかチェックする</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">seeLink</span><span class="p">(</span><span class="s1">&#39;Login&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">seeLink</span><span class="p">(</span><span class="s1">&#39;Login&#39;</span><span class="p">,</span><span class="s1">&#39;/login&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">seeLink</span><span class="p">(</span><span class="s1">&#39;#login a&#39;</span><span class="p">,</span><span class="s1">&#39;/login&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<h4>フォーム</h4>

<p>ウェブサイトのテストにおいてもっとも時間が取られることは、リンクをクリックすることではないです。もし、リンクだけで構成されているサイトならテストを自動化する必要は無いでしょう。
もっとも時間を消費する機能はフォームです。Codeceptionはフォームを処理する方法をいくつか提供します。</p>

<p>それでは、Codeceptionのテストでフォームを送信してみましょう。</p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">action=</span><span class="s">&quot;/update&quot;</span> <span class="na">id=</span><span class="s">&quot;update_form&quot;</span><span class="nt">&gt;</span>
     <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_name&quot;</span><span class="nt">&gt;</span>Name<span class="nt">&lt;/label&gt;</span>
     <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;user[name]&quot;</span> <span class="na">id=</span><span class="s">&quot;user_name&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_email&quot;</span><span class="nt">&gt;</span>Email<span class="nt">&lt;/label&gt;</span>
     <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;user[email]&quot;</span> <span class="na">id=</span><span class="s">&quot;user_email&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_gender&quot;</span><span class="nt">&gt;</span>Gender<span class="nt">&lt;/label&gt;</span>
     <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;user_gender&quot;</span> <span class="na">name=</span><span class="s">&quot;user[gender]&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;m&quot;</span><span class="nt">&gt;</span>Male<span class="nt">&lt;/option&gt;</span>
          <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;f&quot;</span><span class="nt">&gt;</span>Female<span class="nt">&lt;/option&gt;</span>
     <span class="nt">&lt;/select&gt;</span>
     <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">name=</span><span class="s">&quot;submitButton&quot;</span> <span class="na">value=</span><span class="s">&quot;Update&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre></div>
<p>ユーザーからの視点で見ると、このフォームは埋める必要のある複数の項目から構成されており、最後にはUpdateボタンがクリックされます。</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">// user_name項目に対応するラベルを使います</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">fillField</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;Miles&#39;</span><span class="p">);</span>
<span class="c1">// inputタグのname属性やid属性を使用しています</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">fillField</span><span class="p">(</span><span class="s1">&#39;user[email]&#39;</span><span class="p">,</span><span class="s1">&#39;miles@davis.com&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">selectOption</span><span class="p">(</span><span class="s1">&#39;Gender&#39;</span><span class="p">,</span><span class="s1">&#39;Male&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">click</span><span class="p">(</span><span class="s1">&#39;Update&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>それぞれのフィールドをラベルで検索するためには、labelタグに<code>for</code>属性を書く必要があります。</p>

<p>開発者から見ると、フォームを送信することは、サーバーに有効なPOSTリクエストを送信しているだけです。
時には、一度にすべての項目に書き込み、&#39;Submit&#39;ボタンをクリックすることなく送信してしまう方が楽です。そのようなシナリオをたった一つのメソッドで書き換えることが出来ます。</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">submitForm</span><span class="p">(</span><span class="s1">&#39;#update_form&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;user&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
     <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Miles&#39;</span><span class="p">,</span>
     <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Davis&#39;</span><span class="p">,</span>
     <span class="s1">&#39;gender&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;m&#39;</span>
<span class="p">)));</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p><code>submitForm</code>メソッドはユーザーの行動をエミュレートしてはいませんが、フォームが適切にフォーマットされていない時に、非常に有効です。
例えば、ラベルがついていなかったり、不適切なname属性やid属性がつけられているフォームやjavascriptによって送信されているフォームです。</p>

<p>デフォルトでは、<code>submitForm</code>メソッドはボタンの値を送信することはありません。どのボタンのvalueを送信するかは最後の引数に指定出来ますし、あるいは第二引数に含めて指定することも出来ます。</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">submitForm</span><span class="p">(</span><span class="s1">&#39;#update_form&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;user&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
     <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Miles&#39;</span><span class="p">,</span>
     <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Davis&#39;</span><span class="p">,</span>
     <span class="s1">&#39;gender&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;m&#39;</span>
<span class="p">)),</span> <span class="s1">&#39;submitButton&#39;</span><span class="p">);</span>
<span class="c1">// これは同じ機能を果たしますが、送信ボタンのvalueは指定する必要があります</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">submitForm</span><span class="p">(</span><span class="s1">&#39;#update_form&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;user&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
     <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Miles&#39;</span><span class="p">,</span>
     <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Davis&#39;</span><span class="p">,</span>
     <span class="s1">&#39;gender&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span>
     <span class="s1">&#39;submitButton&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Update&#39;</span>
<span class="p">)));</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<h4>Ajaxエミュレーター</h4>

<p>ご存知のように、PHP browserではjavascriptは機能しません。
しかし、すべてのajax呼び出しは、適切なリクエストをサーバーに送信することで簡単にエミュレート出来ます。</p>

<p>ajax通信には以下のメソッドが使えることを覚えておいてください。</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">sendAjaxGetRequest</span><span class="p">(</span><span class="s1">&#39;/refresh&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">sendAjaxPostRequest</span><span class="p">(</span><span class="s1">&#39;/update&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Miles&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Davis&#39;</span><span class="p">));</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<h4>アサーション</h4>

<p>PHP browserでは、ページの内容をテスト出来ます。ほとんどの場合は、ページに必要なテキストや要素が存在しているかチェックする必要があるのみでしょう。</p>

<p>そのためにもっとも使い勝手の良いメソッドは<code>see</code>です。</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">// &#39;Thank you, Miles&#39;というテキストがページにあることをチェックします</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">see</span><span class="p">(</span><span class="s1">&#39;Thank you, Miles&#39;</span><span class="p">);</span>
<span class="c1">// &#39;Thank you Miles&#39;の内部をチェックします</span>
<span class="c1">// この要素は&#39;notice&#39;というクラス属性を持っています</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">see</span><span class="p">(</span><span class="s1">&#39;Thank you, Miles&#39;</span><span class="p">,</span> <span class="s1">&#39;.notice&#39;</span><span class="p">);</span>
<span class="c1">// XPathを使用することもできます</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">see</span><span class="p">(</span><span class="s1">&#39;Thank you, Miles&#39;</span><span class="p">,</span> <span class="s2">&quot;descendant-or-self::*[contains(concat(&#39; &#39;, normalize-space(@class), &#39; &#39;), &#39; notice &#39;)]&quot;</span><span class="p">);</span>
<span class="c1">// このメッセージがページに無いことをチェックしています</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">dontSee</span><span class="p">(</span><span class="s1">&#39;Form is filled incorrectly&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>特定の要素がページに存在する（あるいは存在しない）ことをチェック出来ます。</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">seeElement</span><span class="p">(</span><span class="s1">&#39;.notice&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">dontSeeElement</span><span class="p">(</span><span class="s1">&#39;.error&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>私達は、他にもチェックを実行するために役立つメソッドを用意しています。それらがすべて<code>see</code>というプレフィックスから始まっていることに注目してください。</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">seeInCurrentUrl</span><span class="p">(</span><span class="s1">&#39;/user/miles&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">seeCheckboxIsChecked</span><span class="p">(</span><span class="s1">&#39;#agree&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">seeInField</span><span class="p">(</span><span class="s1">&#39;user[name]&#39;</span><span class="p">,</span> <span class="s1">&#39;Miles&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">seeLink</span><span class="p">(</span><span class="s1">&#39;Login&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<h4>条件付きアサーション</h4>

<p>時にはアサーションが失敗したとしても、途中でテストを止めたくないでしょう。時間のかかるテストを行っていて、最後まで実行したいかもしれません。
この場合には、条件付のアサーションを使用することが出来ます。<code>see</code>メソッドは<code>canSee</code>メソッドに対応しており、<code>dontSee</code>メソッドは<code>cantSee</code>メソッドに対応しています。</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">canSeeInCurrentUrl</span><span class="p">(</span><span class="s1">&#39;/user/miles&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">canSeeCheckboxIsChecked</span><span class="p">(</span><span class="s1">&#39;#agree&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">cantSeeInField</span><span class="p">(</span><span class="s1">&#39;user[name]&#39;</span><span class="p">,</span> <span class="s1">&#39;Miles&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>それぞれの失敗したアサーションはテスト結果に示されますが、アサーションが失敗することでテストが止まることは無いでしょう。</p>

<h4>グラバー</h4>

<p>これらのメソッドはテストで使われるデータを取得します。あなたのサイトがすべてのユーザーごとにパスワードを発行指定、そのパスワードでユーザーがサイトにログインできることをチェックしたいという場面を想像してください。</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">fillField</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;miles@davis.com&#39;</span><span class="p">)</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">click</span><span class="p">(</span><span class="s1">&#39;Generate Password&#39;</span><span class="p">);</span>
<span class="nv">$password</span> <span class="o">=</span> <span class="nv">$I</span><span class="o">-&gt;</span><span class="na">grabTextFrom</span><span class="p">(</span><span class="s1">&#39;#password&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">click</span><span class="p">(</span><span class="s1">&#39;Login&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">fillField</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;miles@davis.com&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">fillField</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="nv">$password</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">click</span><span class="p">(</span><span class="s1">&#39;Log in!&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>グラバーは現在のページから一つの値を取得できるメソッドです。</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$token</span> <span class="o">=</span> <span class="nv">$I</span><span class="o">-&gt;</span><span class="na">grabTextFrom</span><span class="p">(</span><span class="s1">&#39;.token&#39;</span><span class="p">);</span>
<span class="nv">$password</span> <span class="o">=</span> <span class="nv">$I</span><span class="o">-&gt;</span><span class="na">grabTextFrom</span><span class="p">(</span><span class="s2">&quot;descendant::input/descendant::*[@id = &#39;password&#39;]&quot;</span><span class="p">);</span>
<span class="nv">$api_key</span> <span class="o">=</span> <span class="nv">$I</span><span class="o">-&gt;</span><span class="na">grabValueFrom</span><span class="p">(</span><span class="s1">&#39;input[name=api]&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<h4>コメント</h4>

<p>長いシナリオ内では、これから実行しようとしている行動とそれによって得られる結果を説明するべきです。
<code>amGoingTo</code>, <code>expect</code>, <code>expectTo</code>というメソッドは、よりわかりやすいテストを作成する助けとなります。</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">amGoingTo</span><span class="p">(</span><span class="s1">&#39;submit user form with invalid values&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">fillField</span><span class="p">(</span><span class="s1">&#39;user[email]&#39;</span><span class="p">,</span> <span class="s1">&#39;miles&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">click</span><span class="p">(</span><span class="s1">&#39;Update&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">expect</span><span class="p">(</span><span class="s1">&#39;the form is not submitted&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">see</span><span class="p">(</span><span class="s1">&#39;Form is filled incorrectly&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<h4>クッキー、URL、タイトル、その他</h4>

<p>クッキーを扱うためのメソッド：</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">setCookie</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">,</span> <span class="s1">&#39;123345&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">grabCookie</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">seeCookie</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>ページのタイトルを扱うためのメソッド:</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">seeInTitle</span><span class="p">(</span><span class="s1">&#39;Login&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">dontSeeInTitle</span><span class="p">(</span><span class="s1">&#39;Register&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>URLを扱うためのメソッド:</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">seeCurrentUrlEquals</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">seeCurrentUrlMatches</span><span class="p">(</span><span class="s1">&#39;~$/users/(\d+)~&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">seeInCurrentUrl</span><span class="p">(</span><span class="s1">&#39;user/1&#39;</span><span class="p">);</span>
<span class="nv">$user_id</span> <span class="o">=</span> <span class="nv">$I</span><span class="o">-&gt;</span><span class="na">grabFromCurrentUrl</span><span class="p">(</span><span class="s1">&#39;~$/user/(\d+)/~&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<h2>Selenium WebDriver</h2>

<p>Codeceptionのすばらしい特徴は、ほとんどのシナリオが異なるテスト動作環境に容易に移植できることです。
これまでに書いてきたPhpBrowserテストはSelenium WebDriverを使って、実際のブラウザの中で（あるいはPhantomJSでさえ）実行出来ます。</p>

<p>ただひとつだけ変更しなければならない事は、AcceptanceTesterクラスがPhpBrowserの代わりに<strong>WebDriver</strong>を使用するように設定してビルドし直すことです。</p>

<p><code>acceptance.suite.yml</code>ファイルを変更してください：</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">class_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">AcceptanceTester</span>
<span class="l-Scalar-Plain">modules</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">enabled</span><span class="p-Indicator">:</span>
        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">WebDriver</span>
        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">AcceptanceHelper</span>
    <span class="l-Scalar-Plain">config</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">WebDriver</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="s">&#39;http://localhost/myapp/&#39;</span>
            <span class="l-Scalar-Plain">browser</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">firefox</span>
</code></pre></div>
<p>Seleniumでテストを実行するために、<a href="http://seleniumhq.org/download/">Selenium Server</a>をダウンロードして、起動しておく必要があります。（替わりに<code>ghostdriver</code>モードで動くヘッドレスブラウザの<a href="http://phantomjs.org/">PhantomJS</a>を使うことも出来ます。）</p>

<p>Seleniumを使用して受け入れテストを実行するならば、Firefoxから始められます。ブラウザエンジンを使用する事ですべての処理がステップ実行されます。</p>

<p>この場合、<code>seeElement</code>メソッドはページにその要素が存在する事だけをチェックするのではなく、実際のユーザーからの可視性もチェックします。</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">seeElement</span><span class="p">(</span><span class="s1">&#39;#modal&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<h4>Wait</h4>

<p>ウェブアプリケーションをテストしている間に、JavaScriptのeventが起こるまで待機しておく必要があるかもしれません。
複雑なJavaScriptの処理は、その非同期性によってテストが困難になります。テストが先に進んでしまう前に、そのページで起こると予測しているeventを指定できるように、<code>wait</code>メソッドが必要なのです。</p>

<p>例：</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">waitForElement</span><span class="p">(</span><span class="s1">&#39;#agree_button&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span> <span class="c1">// secs</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">click</span><span class="p">(</span><span class="s1">&#39;#agree_button&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>この場合には、agree buttonが表示されるまで待機し、表示されたらクリックします。30秒経過しても表示されなかったときは、テストは失敗します。他にも使える<code>wait</code>メソッドがあります。</p>

<p>詳細なリファレンスはCodeception&#39;s <a href="http://codeception.com/docs/modules/WebDriver">WebDriver module documentation</a>を参照してください。</p>

<h3>複数セッションのテスト</h3>

<p>Codeceptionは同時に複数のセッションを実行出来ます。サイト上でユーザ同士がリアルタイムにメッセージをやり取りする場合がもっともわかりやすいです。そのためには２つのブラウザウィンドウを同じテスト中に同時に立ち上げる必要があるでしょう。Codeceptionはこのための<strong>Friends</strong>と呼ばれるとってもスマートな方法が用意されています。</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$I</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AcceptanceTester</span><span class="p">(</span><span class="nv">$scenario</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">wantTo</span><span class="p">(</span><span class="s1">&#39;try multi session&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">amOnPage</span><span class="p">(</span><span class="s1">&#39;/messages&#39;</span><span class="p">);</span>
<span class="nv">$nick</span> <span class="o">=</span> <span class="nv">$I</span><span class="o">-&gt;</span><span class="na">haveFriend</span><span class="p">(</span><span class="s1">&#39;nick&#39;</span><span class="p">);</span>
<span class="nv">$nick</span><span class="o">-&gt;</span><span class="na">does</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="nx">AcceptanceTester</span> <span class="nv">$I</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$I</span><span class="o">-&gt;</span><span class="na">amOnPage</span><span class="p">(</span><span class="s1">&#39;/messages/new&#39;</span><span class="p">);</span>
    <span class="nv">$I</span><span class="o">-&gt;</span><span class="na">fillField</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="s1">&#39;Hello all!&#39;</span><span class="p">)</span>
    <span class="nv">$I</span><span class="o">-&gt;</span><span class="na">click</span><span class="p">(</span><span class="s1">&#39;Send&#39;</span><span class="p">);</span>
    <span class="nv">$I</span><span class="o">-&gt;</span><span class="na">see</span><span class="p">(</span><span class="s1">&#39;Hello all!&#39;</span><span class="p">,</span> <span class="s1">&#39;.message&#39;</span><span class="p">);</span>
<span class="p">});</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">wait</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">see</span><span class="p">(</span><span class="s1">&#39;Hello all!&#39;</span><span class="p">,</span> <span class="s1">&#39;.message&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>この場合には、2つ目のウィンドウでfriendオブジェクトが<code>does</code>メソッドを使用していくつかの行動をしました。</p>

<h3>クリーンアップ</h3>

<p>テストをしている中で、あなたの行動はサイト上のデータを変えてしまうかもしれません。2度同じデータを生成したり、アップデートしようとしてテストは失敗する事になるでしょう。この問題を避けるために、データベースはそれぞれのテストごとに再構築する必要があります。Codeceptionはそのために<code>Db</code>モジュールを提供しています。テストを通過した後にデータベースのdumpをロードします。データベースの再構築を機能させるためには、データベースをdumpしてsqlファイルを作成し、<strong>/tests/_data</strong>ディレクトリに配置してください。Codeceptionのglobalの設定にデータベースへの接続情報とパスをセットしてください。</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="c1"># in codeception.yml:</span>
<span class="l-Scalar-Plain">modules</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">config</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">Db</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">dsn</span><span class="p-Indicator">:</span> <span class="s">&#39;[set</span><span class="nv"> </span><span class="s">pdo</span><span class="nv"> </span><span class="s">dsn</span><span class="nv"> </span><span class="s">here]&#39;</span>
            <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="s">&#39;[set</span><span class="nv"> </span><span class="s">user]&#39;</span>
            <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="s">&#39;[set</span><span class="nv"> </span><span class="s">password]&#39;</span>
            <span class="l-Scalar-Plain">dump</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">tests/_data/dump.sql</span>
</code></pre></div>
<h3>デバッグ</h3>

<p>Codeceptionモジュールは実行中に価値のある情報を出力できます。実行中の詳細を見るために<code>--debug</code>オプションをテスト起動時に付けるだけです。出力をカスタマイズするには<code>codecept_debug</code>ファンクションを使います。</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nx">codecept_debug</span><span class="p">(</span><span class="nv">$I</span><span class="o">-&gt;</span><span class="na">grabTextFrom</span><span class="p">(</span><span class="s1">&#39;#name&#39;</span><span class="p">));</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>テストの失敗ごとに、最後に表示されていたページのスナップショットを<strong>tests/_log</strong>ディレクトリに保存します。PhpBrowserはHTMLのコードを保存し、WebDriverはページのスクリーンショットを保存します。</p>

結論</h2>

<p>CodeceptionとPhpBrowserで受け入れテストを書くことは、良いスタートです。フレームワークで作られたサイトと同じように、Joomla, Drupal, WordPressのサイトも簡単にテスト出来ます。受け入れテストを書くことはPHPでのテスターの行動を説明するようなものです。可読性に長け、とても書きやすいです。テストを実行するごとにデータベースの再構築を忘れないように。</p>

    </section>
</div>

<!-- FOOTER  -->
<div id="footer_wrap" class="outer">
    <footer class="inner">
        <p class="copyright">Codeception.docs.ja maintained by <a href="https://github.com/piccagliani">piccagliani</a></p>
        <p>Last updated: 2015-02-23 16:47:13 +0900, Based on <a href="https://github.com/Codeception/Codeception/tree/2.0">Codeception</a>@4e267293bb</p>
        <div id="contributors"></div>
    </footer>
</div>

<script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-59804278-1");
        pageTracker._trackPageview();
    } catch(err) {}
</script>
<script src="//code.jquery.com/jquery-2.1.3.min.js"></script>
<script src="//piccagliani.github.io/Codeception.docs.ja_JP/javascripts/contributors.js"></script>

</body>
</html>
