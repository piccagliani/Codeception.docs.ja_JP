<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Codeception.docs.ja : Codeception docs japanese translation">

    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/guides.css">

    <title>Codeception.docs.ja</title>
</head>

<body>

<!-- HEADER -->
<div id="header_wrap" class="outer">
    <header class="container inner">
        <a id="forkme_banner" href="https://github.com/piccagliani/Codeception.docs.ja_JP">View on GitHub</a>

        <h1 id="project_title"><a href="index.html">Codeception.docs.ja</a></h1>
        <h2 id="project_tagline">Codeception docs japanese translation</h2>

        <section id="downloads">
            <a class="zip_download_link" href="https://github.com/piccagliani/Codeception.docs.ja_JP/zipball/master">Download this project as a .zip file</a>
            <a class="tar_download_link" href="https://github.com/piccagliani/Codeception.docs.ja_JP/tarball/master">Download this project as a tar.gz file</a>
        </section>
    </header>
</div>

<!-- MAIN CONTENT -->
<div id="main_content_wrap" class="container">
    <div class="row">
        <section id="main_content" class="col-md-9">
            <h1>データを取り扱う</h1>

<p>テストはお互いに影響を及ぼし合ってはなりません。これが大雑把なルールです。
テストがデータベースとやり取りする際に内部のデータを変更しかねないため、最終的にデータの不一致や矛盾を生じさせるかもしれないのです。テストはすでに挿入されているレコードを挿入したり、削除されているレコードを検索しようとするかもしれません。テストの失敗を回避するため、データベースは各テストを行う前に初期状態になっていなければなりません。Codeceptionには、データをクリーンにするための方法やアプローチがいくつか存在します。</p>

<p>この章では、前章のクリーンアップに関する注意を要約するとともに、データストレージバックエンドを選択する方法の最善策について提案します。</p>

<p>私たちがデータベースをクリーンアップすると決めた時、私たちはそれをできるだけ速く行うべきです。テストは常に速く実行される必要があります。データベースを一から再構築するのは最良の方法とは言えないかもしれませんが、唯一の方法とも言えるかもしれません。いずれにせよ、テストのためだけに特別なデータベースを使用してください。<strong>絶対に開発環境または本番環境のデータベースでテストを実行しないでください!</strong></p>

<h2>自動クリーンアップ</h2>

<p>Codeceptionにはデータベースと対話をする際に必要なほとんどのタスクを行ってくれる<code>Db</code>モジュールがあります。デフォルトでは、dumpからデータベースを再構築し、各テストが終了した後にクリーンアップを試みます。このモジュールのデータベースのdumpはSQLフォーマットです。<code>codeception.yml</code>内ですでに設定が準備されています。</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">modules</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">config</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">Db</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">dsn</span><span class="p-Indicator">:</span> <span class="s">&#39;PDO</span><span class="nv"> </span><span class="s">DSN</span><span class="nv"> </span><span class="s">HERE&#39;</span>
            <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="s">&#39;root&#39;</span>
            <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">dump</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">tests/_data/your-dump-name.sql</span>
</code></pre></div>
<p>あなたのテストスイートでこのモジュールを有効化したら、自動的にdumpからデータベースにデータが挿入され、各テストの実行時に再構築されます。これらの設定は<code>populate</code> と <code>cleanup</code>オプションの変更によって<code>false</code>に設定することができます。</p>

<p><code>Db</code>モジュールはラフなツールです。PDOでサポートされているどのデータベースでも動作します。もし速度が遅くなければ、すべてのテストで使用できます。dumpをロードするのはとても時間がかかりますが、他の手段を使うこともできます。機能テストや単体テストを行う際などにアプリケーションとテストがデータベース接続を共有している時、速度を向上させる最善策はすべてのコードをトランザクションに設置し、テスト終了時にロールバックすることです。</p>

<h2>分離された接続</h2>

<p>受け入れテストでは、異なるデータベース接続が使用されているため、テスト速度を向上するにはSQLiteファイルのデータベースを使うことができます。また、代替案として、各テストごとにデータベースを作成するのを避け、テスト終了後にすべてのアップデートをクリーンアップすることも考えられます。Dbモジュールはあなたのアプリケーションと同等の機能を提供しており、アサーション(<code>seeInDatabase</code>アクション)のためにデータベースにアクセスしたり、自動クリーンアップしたりします。</p>

<h2>共有された接続</h2>

<p>あなたのアプリケーションもしくはその一部がCodeceptionプロセス内で実行されている場合、アプリケーション接続をテストで使用することが可能です。接続にアクセスできれば、すべてのデータベース操作はグローバルトランザクションに含むことができ、最後にロールバックされます。それは劇的にパフォーマンスを改善するでしょう。最後にデータベースに何も書かれないため、実際にデータベースの再構築が必要とならないのです。</p>

<h3>ORM モジュール</h3>

<p>アプリケーションがDoctrineやDoctrine2のようなORMを使用しているのでしたら、各モジュールでスイートに接続してください。デフォルトでは、トランザクション内のすべてをカバーします。もしあなたが複数のデータベース接続を使っていない、もしくはORMによって追跡されないトランザクションである場合、このモジュールはあなたの役には立たないでしょう。</p>

<p>ORMモジュールは<code>Db</code>モジュールと接続できますが、デフォルトでは両方ともクリーンアップを行います。従って、あなたが明示的に使用しているモジュールを設定する必要があります。</p>

<p><code>tests/functional.suite.yml</code>は次のようになります。</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">modules</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">enabled</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">Db</span><span class="p-Indicator">,</span> <span class="nv">Doctrine2</span><span class="p-Indicator">,</span> <span class="nv">FunctionalHelper</span><span class="p-Indicator">]</span>
    <span class="l-Scalar-Plain">config</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">Db</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">cleanup</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</code></pre></div>
<p><code>Db</code>モジュールは未だテスト後にdumpからデータベースの再構築を行います。<code>populate: false</code>を使って、それを無効にしてください。</p>

<h3>Dbh モジュール</h3>

<p>PostgreSQLまたは他のネストされたトランザクションをサポートしているデータベースを使っているのでしたら、<code>Dbh</code>モジュールを使用してください。アプリケーションからPDOインスタンスを取得し、テストの開始でトランザクションを開始して終了後にロールバックします。PDO接続はブートストラップファイルで定義することができます。このモジュールは<code>Db</code>モジュールの<code>seeInDatabase</code>メソッドと<code>dontSeeInDatabase</code>メソッドを上書きします。</p>

<p>再構築に<code>Db</code>モジュールを使用し、クリーンアップに<code>Dhp</code>モジュールを行うには、次のように設定してください。</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">modules</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">enabled</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">Db</span><span class="p-Indicator">,</span> <span class="nv">Dbh</span><span class="p-Indicator">,</span> <span class="nv">FunctionalHelper</span><span class="p-Indicator">]</span>
    <span class="l-Scalar-Plain">config</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">Db</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">cleanup</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</code></pre></div>
<p><code>Dbh</code>モジュールは<code>Db</code>モジュールの後に来なければいけないことに注意してください。これによって<code>Dbh</code>モジュールはアクションを上書きできるようになります。</p>

<h2>フィクスチャ</h2>

<p>フィクスチャはテストで使用できるサンプルデータです。このデータは生成されるか、サンプルデータベースから取得されます。フィクスチャは別のPHPファイルで定義され、テストにロードできます。</p>

<h4>受け入れテストと機能テストのフィクスチャ</h4>

<p><code>tests/functional</code>内に<code>fixtures.php</code>ファイルを作り、テストで使用するデータをデータベースからロードしてみましょう。</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">// サンプルデータベースからユーザを取得します</span>
<span class="c1">// Dbモジュールを使用します</span>
<span class="nv">$john</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">findOneBy</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;john&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>受け入れテストと機能テストのサンプルでのフィクスチャの使用方法です:</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">require</span> <span class="s1">&#39;fixtures.php&#39;</span><span class="p">;</span>

<span class="nv">$I</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FunctionalTester</span><span class="p">(</span><span class="nv">$scenario</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">amLoggedAs</span><span class="p">(</span><span class="nv">$john</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">see</span><span class="p">(</span><span class="s1">&#39;Welcome, John&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>また、<a href="https://github.com/fzaninotto/Faker">Faker</a> ライブラリを使ってブートストラップファイル内にテストデータを作成することもできます。</p>

<h3>テストごとのフィクスチャ</h3>

<p>もしあなたが1つのテストに対して特別なデータベースレコードを作りたいのなら、<code>Db</code>モジュールの<a href="http://codeception.com/docs/modules/Db#haveInDatabase"><code>haveInDatabase</code></a>メソッドを使用できます。</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$I</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FunctionalTester</span><span class="p">(</span><span class="nv">$scenario</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">haveInDatabase</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Top 10 Testing Frameworks&#39;</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;1. Codeception&#39;</span><span class="p">));</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">amOnPage</span><span class="p">(</span><span class="s1">&#39;/posts&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">see</span><span class="p">(</span><span class="s1">&#39;Top 10 Testing Frameworks&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p><code>haveInDatabase</code>は、与えられた値の行を新しくデータベースに挿入します。追加されたレコードはすべてテスト終了後に削除されます。似たように<code>MongoDB</code>モジュールでは、<a href="http://codeception.com/docs/modules/MongoDb#haveInCollection"><code>haveInCollection</code></a>メソッドが存在します。</p>

<h2>まとめ</h2>

<p>Codeceptionは、データを取り扱う開発者を見捨てたりしません。データベースを構築したりクリーンアップするためのツールは<code>Db</code>モジュール内にバンドルされています。テストでサンプルデータを操作するには、ブートストラップファイル内で定義されるフィクスチャを使用してください。</p>

        </section>
        <nav id="nav" class="col-md-3">
            <div class="well">
                <ol>
                    <li><a href="01-Introduction.html">イントロダクション</a></li>
                    <li><a href="02-GettingStarted.html">はじめに</a></li>
                    <li><a href="03-ModulesAndHelpers.html">モジュールとヘルパー</a></li>
                    <li><a href="04-AcceptanceTests.html">受け入れテスト</a></li>
                    <li><a href="05-FunctionalTests.html">機能テスト</a></li>
                    <li><a href="06-UnitTests.html">単体テスト</a></li>
                    <li><a href="07-AdvancedUsage.html">高度な使用法</a></li>
                    <li><a href="08-Customization.html">カスタマイズ</a></li>
                    <li><a href="09-Data.html">データを取り扱う</a></li>
                    <li><a href="10-WebServices.html">Webサービスをテストする</a></li>
                    <li><a href="11-Codecoverage.html">コードカバレッジ</a></li>
                    <li><a href="12-ParallelExecution.html">並列実行</a></li>
                </ol>
            </div>
        </nav>
    </div>
</div>

<!-- FOOTER  -->
<div id="footer_wrap" class="outer">
    <footer class="container inner">
        <p class="copyright">Codeception.docs.ja maintained by <a target="_blank" href="https://github.com/piccagliani">piccagliani</a></p>
        <p>Last updated: 2015-03-05 18:10:00 +0900, Based on <a target="_blank" href="https://github.com/Codeception/Codeception/releases/tag/2.0.11">Codeception 2.0.11</a></p>
        <div id="contributors"></div>
    </footer>
</div>

<script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-59804278-1");
        pageTracker._trackPageview();
    } catch(err) {}
</script>
<script src="//code.jquery.com/jquery-2.1.3.min.js"></script>
<script src="javascripts/contributors.js"></script>
</body>
</html>
