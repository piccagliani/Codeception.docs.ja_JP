<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Codeception.docs.ja : Codeception docs japanese translation">

    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/guides.css">

    <title>Codeception.docs.ja</title>
</head>

<body>

<!-- HEADER -->
<div id="header_wrap" class="outer">
    <header class="container inner">
        <a id="forkme_banner" href="https://github.com/piccagliani/Codeception.docs.ja_JP">View on GitHub</a>

        <h1 id="project_title"><a href="index.html">Codeception.docs.ja</a></h1>
        <h2 id="project_tagline">Codeception docs japanese translation</h2>

        <section id="downloads">
            <a class="zip_download_link" href="https://github.com/piccagliani/Codeception.docs.ja_JP/zipball/master">Download this project as a .zip file</a>
            <a class="tar_download_link" href="https://github.com/piccagliani/Codeception.docs.ja_JP/tarball/master">Download this project as a tar.gz file</a>
        </section>
    </header>
</div>

<!-- MAIN CONTENT -->
<div id="main_content_wrap" class="container">
    <div class="row">
        <section id="main_content" class="col-md-9">
            <h1>Webサービスをテストする</h1>

<p>CodeceptionはWebサイトのテストと同じ方法で、Webサービスをテストすることができます。Webサービスを手動でテストすることはとても大変なので、テストを自動化することはとても良いアイディアです。CodeceptionにはSOAPとRESTに対応したモジュールが標準で備えられています。この章ではそれらのモジュールについて説明します。</p>

<p>新しくテストスイートを作成するところからはじめましょう。これは <code>bootstrap</code> コマンドでは提供されていません。テストスイートの名前は <strong>api</strong> とし、<code>ApiTester</code> クラスを使いましょう。</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>php codecept.phar generate:suite api
</code></pre></div>
<p>ここにAPIのテストを記述していきます。</p>

<h2>REST</h2>

<p>REST方式のWebサービスは、HTTPの標準的なメソッドである <code>GET</code>、<code>POST</code>、<code>PUT</code>、<code>DELETE</code> を介してアクセスされます。これにより、Webサービスからエンティティを受け取り、操作することができます。WebサービスへのアクセスにはHTTPクライアントが必要であるため、<code>PhpBrowser</code> やいずれかのフレームワーク用モジュールのセットアップを行う必要があります。Webサーバーを無視し、Webサービスを内部的にテストするために、たとえば、Symfony2 で実装されたアプリケーションであれば、<code>Symfony2</code> モジュールを使用します。</p>

<p><code>api.suite.yml</code> にモジュールの設定を行います。</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">class_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ApiTester</span>
<span class="l-Scalar-Plain">modules</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">enabled</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">PhpBrowser</span><span class="p-Indicator">,</span> <span class="nv">REST</span><span class="p-Indicator">,</span> <span class="nv">ApiHelper</span><span class="p-Indicator">]</span>
    <span class="l-Scalar-Plain">config</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">PhpBrowser</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://serviceapp/</span>
        <span class="l-Scalar-Plain">REST</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://serviceapp/api/v1/</span>
</code></pre></div>
<p>RESTモジュールは自動的に <code>PhpBrowser</code> に接続します。Symfony2、Laravel4、Zendやそのほかのフレームワークモジュールによって提供する場合においても同様に接続します。設定の編集が完了したら、<code>build</code> コマンドを実行するのを忘れないでください。</p>

<p>それでは最初のテストを作成しましょう。</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>php codecept.phar generate:cept api CreateUser
</code></pre></div>
<p>これを <code>CreateUserCept.php</code> と呼ぶこととします。Webサービスを介してのユーザーの作成をテストするために使用します。</p>

<p><code>CreateUserCept.php</code></p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$I</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ApiTester</span><span class="p">(</span><span class="nv">$scenario</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">wantTo</span><span class="p">(</span><span class="s1">&#39;create a user via API&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">amHttpAuthenticated</span><span class="p">(</span><span class="s1">&#39;service_user&#39;</span><span class="p">,</span> <span class="s1">&#39;123456&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">haveHttpHeader</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">sendPOST</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;davert&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;davert@codeception.com&#39;</span><span class="p">]);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">seeResponseCodeIs</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">seeResponseIsJson</span><span class="p">();</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">seeResponseContains</span><span class="p">(</span><span class="s1">&#39;{&quot;result&quot;:&quot;ok&quot;}&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>RESTモジュールはJSON形式をレスポンスするWebサービスを扱えるよう設計されています。たとえば、<code>seeResponseContainsJson</code> メソッドは与えられた配列をJSON形式に変換し、それがレスポンスに含まれているかどうかをチェックします。</p>

<p>レスポンスに対して、より複雑な検証を行いたい場合があると思います。そのためには <a href="http://codeception.com/docs/03-ModulesAndHelpers#Helpers">ヘルパー</a> クラスに独自のメソッドを記述します。最後のJSONレスポンスにアクセスするためには、<code>REST</code> モジュールの <code>response</code> プロパティーを使用します。次に示す <code>seeResponseIsHtml</code> メソッドで説明しましょう。</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">ApiHelper</span> <span class="k">extends</span> <span class="nx">\Codeception\Module</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">seeResponseIsHtml</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getModule</span><span class="p">(</span><span class="s1">&#39;REST&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">response</span><span class="p">;</span>
        <span class="nx">\PHPUnit_Framework_Assert</span><span class="o">::</span><span class="na">assertRegex</span><span class="p">(</span><span class="s1">&#39;~^&lt;!DOCTYPE HTML(.*?)&lt;html&gt;.*?&lt;\/html&gt;~m&#39;</span><span class="p">,</span> <span class="nv">$response</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>同じ方法で、リクエストパラメーターや、ヘッダー情報を取得することができます。</p>

<h2>SOAP</h2>

<p>SOAP方式のWebサービスは通常、より複雑になります。<a href="http://php.net/manual/ja/soap.installation.php">SOAPサポートを有効にする</a>必要があります。XMLに関する十分な知識も必要とされます。<code>SOAP</code> モジュールは、WSDLで表されたWebサービスに接続するために、特別な形式のPOSTリクエストを利用します。Codeceptionは <code>PhpBrowser</code>やいずれかのフレームワーク用モジュールを用いてやり取りを行います。もしフレームワーク用モジュールを選択した場合、SOAPモジュールは自動的に基盤となるフレームワークに接続します。これにより、テスト実行の速度を向上させることができ、詳細なスタックトレースを提供できるようになります。</p>

<p>それでは <code>PhpBrowser</code> とともに使用する <code>SOAP</code> モジュールを設定しましょう。</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">class_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ApiTester</span>
<span class="l-Scalar-Plain">modules</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">enabled</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">PhpBrowser</span><span class="p-Indicator">,</span> <span class="nv">SOAP</span><span class="p-Indicator">,</span> <span class="nv">ApiHelper</span><span class="p-Indicator">]</span>
    <span class="l-Scalar-Plain">config</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">PhpBrowser</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://serviceapp/</span>
        <span class="l-Scalar-Plain">SOAP</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">endpoint</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://serviceapp/api/v1/</span>
</code></pre></div>
<p>SOAPリクエストには認証や支払いのようなアプリケーション固有の情報を含みます。この情報はXMLリクエストの <code>&lt;soap:Header&gt;</code> 要素に含まれるSOAPヘッダーによって提供されます。もしこのようなヘッダーを送信したい場合、<code>haveSoapHeader</code> メソッドを使用することができます。たとえば次のようになります。</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">haveSoapHeader</span><span class="p">(</span><span class="s1">&#39;Auth&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Miles&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;123456&#39;</span><span class="p">));</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>このコードは次のXMLヘッダーを生成します。</p>
<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;soap:Header&gt;</span>
<span class="nt">&lt;Auth&gt;</span>
    <span class="nt">&lt;username&gt;</span>Miles<span class="nt">&lt;/username&gt;</span>
    <span class="nt">&lt;password&gt;</span>123456<span class="nt">&lt;/password&gt;</span>
<span class="nt">&lt;/Auth&gt;</span>
<span class="nt">&lt;/soap:Header&gt;</span>
</code></pre></div>
<p>リクエストのボディを定義するためには <code>sendSoapRequest</code> を使用します。</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">sendSoapRequest</span><span class="p">(</span><span class="s1">&#39;CreateUser&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;name&gt;Miles Davis&lt;/name&gt;&lt;email&gt;miles@davis.com&lt;/email&gt;&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>この呼び出しは次のXMLに変換されます。</p>
<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;soap:Body&gt;</span>
<span class="nt">&lt;ns:CreateUser&gt;</span>
    <span class="nt">&lt;name&gt;</span>Miles Davis<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;email&gt;</span>miles@davis.com<span class="nt">&lt;/email&gt;</span>
<span class="nt">&lt;/ns:CreateUser&gt;</span>
<span class="nt">&lt;/soap:Body&gt;</span>
</code></pre></div>
<p>そして、SOAPモジュールで使用できるアサーションの一覧がこちらです。</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">seeSoapResponseEquals</span><span class="p">(</span><span class="s1">&#39;&lt;?xml version=&quot;1.0&quot;?&gt;&lt;error&gt;500&lt;/error&gt;&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">seeSoapResponseIncludes</span><span class="p">(</span><span class="s1">&#39;&lt;result&gt;1&lt;/result&gt;&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">seeSoapResponseContainsStructure</span><span class="p">(</span><span class="s1">&#39;&lt;user&gt;&lt;name&gt;&lt;/name&gt;&lt;email&gt;&lt;/email&gt;&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">seeSoapResponseContainsXPath</span><span class="p">(</span><span class="s1">&#39;//result/user/name[@id=1]&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>もし長いXMLを記述したくない場合、<a href="http://codeception.com/docs/reference/XmlBuilder">XmlBuilder</a> クラスの利用を考えてみてください。これはjQueryのようなスタイルで複雑なXMLを構築するのに役に立ちます。
次の例では通常のXMLに替えて、（SoapUtilsファクトリによって作成された）<code>XmlBuilder</code> を使用しています。</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">use</span> <span class="nx">\Codeception\Util\Soap</span><span class="p">;</span>

<span class="nv">$I</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ApiTester</span><span class="p">(</span><span class="nv">$scenario</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">wantTo</span><span class="p">(</span><span class="s1">&#39;create user&#39;</span><span class="p">);</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">haveSoapHeader</span><span class="p">(</span><span class="s1">&#39;Session&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;token&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;123456&#39;</span><span class="p">));</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">sendSoapRequest</span><span class="p">(</span><span class="s1">&#39;CreateUser&#39;</span><span class="p">,</span> <span class="nx">Soap</span><span class="o">::</span><span class="na">request</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">user</span><span class="o">-&gt;</span><span class="na">email</span><span class="o">-&gt;</span><span class="na">val</span><span class="p">(</span><span class="s1">&#39;miles@davis.com&#39;</span><span class="p">));</span>
<span class="nv">$I</span><span class="o">-&gt;</span><span class="na">seeSoapResponseIncludes</span><span class="p">(</span><span class="nx">Soap</span><span class="o">::</span><span class="na">response</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">result</span><span class="o">-&gt;</span><span class="na">val</span><span class="p">(</span><span class="s1">&#39;Ok&#39;</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">user</span><span class="o">-&gt;</span><span class="na">attr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p><code>XmlBuilder</code> を使うか、プレーンなXMLを利用するかは、どちらでも構いません。<code>XmlBuilder</code> も同様にXML文字列を返します。</p>

<p>ヘルパークラスの中で<code>SOAP</code>モジュールを利用することにより、機能を拡張することができます。<code>\DOMDocument</code> としてSOAPレスポンスにアクセスするためには、<code>SOAP</code> モジュールの <code>response</code> プロパティーを使用します。</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">ApiHelper</span> <span class="k">extends</span> <span class="nx">\Codeception\Module</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">seeResponseIsValidOnSchema</span><span class="p">(</span><span class="nv">$schema</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getModule</span><span class="p">(</span><span class="s1">&#39;SOAP&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">response</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertTrue</span><span class="p">(</span><span class="nv">$response</span><span class="o">-&gt;</span><span class="na">schemaValidate</span><span class="p">(</span><span class="nv">$schema</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<h2>まとめ</h2>

<p>CodeceptionはさまざまなWebサービスをテストするために役立つモジュールを2つ備えています。それらを利用するために 新しく <code>api</code> スイートを作成する必要がありました。レスポンスボディだけのテストしかできないわけではないことを覚えておいてください。<code>Db</code> モジュールを使用することで、<code>CreateUser</code> の呼び出し後にユーザーが作成されているかどうかテストすることができます。ヘルパーメソッドを利用することでRESTやSOAPを使ったテストシナリオを向上することができます。</p>

        </section>
        <nav id="nav" class="col-md-3">
            <div class="well">
                <ol>
                    <li><a href="01-Introduction.html">イントロダクション</a></li>
                    <li><a href="02-GettingStarted.html">はじめに</a></li>
                    <li><a href="03-ModulesAndHelpers.html">モジュールとヘルパー</a></li>
                    <li><a href="04-AcceptanceTests.html">受け入れテスト</a></li>
                    <li><a href="05-FunctionalTests.html">機能テスト</a></li>
                    <li><a href="06-UnitTests.html">単体テスト</a></li>
                    <li><a href="07-AdvancedUsage.html">高度な使用法</a></li>
                    <li><a href="08-Customization.html">カスタマイズ</a></li>
                    <li><a href="09-Data.html">データを取り扱う</a></li>
                    <li><a href="10-WebServices.html">Webサービスをテストする</a></li>
                    <li><a href="11-Codecoverage.html">コードカバレッジ</a></li>
                    <li><a href="12-ParallelExecution.html">並列実行</a></li>
                </ol>
            </div>
        </nav>
    </div>
</div>

<!-- FOOTER  -->
<div id="footer_wrap" class="outer">
    <footer class="container inner">
        <p class="copyright">Codeception.docs.ja maintained by <a target="_blank" href="https://github.com/piccagliani">piccagliani</a></p>
        <p>Last updated: 2015-03-05 18:10:00 +0900, Based on <a target="_blank" href="https://github.com/Codeception/Codeception/releases/tag/2.0.11">Codeception 2.0.11</a></p>
        <div id="contributors"></div>
    </footer>
</div>

<script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-59804278-1");
        pageTracker._trackPageview();
    } catch(err) {}
</script>
<script src="//code.jquery.com/jquery-2.1.3.min.js"></script>
<script src="javascripts/contributors.js"></script>
</body>
</html>
